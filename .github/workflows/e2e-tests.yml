name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:5.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_DATABASE: negces_test
        options: >-
          --health-cmd mongo
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: |
          client/package-lock.json
          server/package-lock.json
    
    # Install dependencies
    - name: Install client dependencies
      run: |
        cd client
        npm ci
    
    - name: Install server dependencies
      run: |
        cd server
        npm ci
    
    # Setup environment variables
    - name: Create server .env file
      run: |
        cd server
        cat > .env << EOF
        MONGODB_URI=mongodb://localhost:27017/negces_test
        NODE_ENV=test
        PORT=5001
        FIREBASE_SERVICE_ACCOUNT_PATH=./config/serviceAccountKey.json.example
        EOF
    
    - name: Create client .env file
      run: |
        cd client
        cat > .env << EOF
        VITE_API_URL=http://localhost:5001/api
        VITE_FIREBASE_API_KEY=test-key
        VITE_FIREBASE_AUTH_DOMAIN=test.firebaseapp.com
        VITE_FIREBASE_PROJECT_ID=test-project
        VITE_FIREBASE_STORAGE_BUCKET=test.appspot.com
        VITE_FIREBASE_MESSAGING_SENDER_ID=123456789
        VITE_FIREBASE_APP_ID=1:123456789:web:abcdef
        PLAYWRIGHT_BASE_URL=http://localhost:5173
        EOF
    
    # Start backend server
    - name: Start server
      run: |
        cd server
        npm start &
        sleep 5
    
    # Install Playwright
    - name: Install Playwright Browsers
      run: |
        cd client
        npx playwright install --with-deps
    
    # Start frontend dev server
    - name: Start client dev server
      run: |
        cd client
        npm run dev &
        sleep 10
    
    # Run the tests
    - name: Run Playwright tests
      run: |
        cd client
        npx playwright test
    
    # Upload test results
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: client/playwright-report/
        retention-days: 30
    
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: client/test-results/
        retention-days: 30

  test-mobile:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: client/package-lock.json
    
    - name: Install dependencies
      run: |
        cd client
        npm ci
    
    - name: Install Playwright
      run: |
        cd client
        npx playwright install --with-deps
    
    - name: Run mobile tests
      run: |
        cd client
        npx playwright test --project="Mobile Chrome" --project="Mobile Safari"
    
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mobile-test-results
        path: client/test-results/
        retention-days: 7
